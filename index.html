<!DOCTYPE html>
<html lang="zh-Hant">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=1.0, user-scalable=no">
    <title>Travel App Template</title>
    <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.4.0/css/all.min.css">
    <link rel="stylesheet" href="https://unpkg.com/leaflet@1.9.4/dist/leaflet.css" />
    <link href="https://fonts.googleapis.com/css2?family=Montserrat:wght@300;400;500;700&display=swap" rel="stylesheet">
  
    <style>
        :root {
            --bg-color: #f0f0f0; /* 淺灰背景 */
            --card-color: #ffffff; /* 白色卡片 */
            --accent-color: #333333; /* 深灰強調色 */
            --text-on-dark: #ffffff; /* 深背景文字 */
            --text-on-light: #000000; /* 淺背景文字 */
            --menu-bg: #dddddd; /* 中灰菜單背景 */
            --weather-gradient: linear-gradient(135deg, #cccccc 0%, #888888 100%); /* 灰色漸層 */
            --highlight-gold: #666666; /* 中灰點綴 */
        }
        * { box-sizing: border-box; -webkit-tap-highlight-color: transparent; }
        body {
            font-family: "Montserrat", sans-serif;
            background-color: var(--bg-color);
            color: var(--text-on-light);
            margin: 0; padding: 0;
            height: 100vh;
            display: flex; flex-direction: column; overflow: hidden;
        }
        /* --- Header --- */
        header {
            padding: 15px 20px;
            background-color: var(--bg-color);
            border-bottom: 1px solid var(--menu-bg);
            position: sticky; top: 0; z-index: 100;
            display: flex; justify-content: space-between; align-items: center;
            height: 60px;
        }
        header h1 { margin: 0; font-size: 1.2rem; letter-spacing: 1px; color: var(--accent-color); }
      
        .header-icons { display: flex; gap: 20px; align-items: center; }
        .header-btn { color: var(--text-on-light); font-size: 1.2rem; cursor: pointer; text-decoration: none; position: relative;}
        .fan-btn i { color: var(--accent-color); }
        /* --- Global Date Selector --- */
        .date-selector-container {
            background: var(--bg-color); z-index: 90;
            padding: 10px 20px 10px 20px;
            box-shadow: 0 4px 10px rgba(0,0,0,0.1);
        }
        .date-selector {
            display: flex; overflow-x: auto; gap: 10px; padding-bottom: 5px; scrollbar-width: none;
            -webkit-overflow-scrolling: touch;
        }
        .date-selector::-webkit-scrollbar { display: none; }
      
        .date-chip {
            background: var(--menu-bg);
            padding: 8px 12px; border-radius: 20px;
            white-space: nowrap; font-size: 0.85rem; cursor: pointer; color: var(--text-on-light);
            display: flex; flex-direction: column; align-items: center; min-width: 55px;
            transition: all 0.2s ease;
            border: 1px solid transparent;
        }
        .date-chip.active {
            background: var(--accent-color); color: var(--text-on-dark);
            box-shadow: 0 0 10px rgba(51,51,51,0.3); transform: scale(1.05);
        }
        /* --- Main Content --- */
        main { flex: 1; overflow-y: hidden; position: relative; }
        .page {
            position: absolute; top: 0; left: 0; width: 100%; height: 100%;
            overflow-y: auto; padding: 10px 0 90px 0;
            display: none; opacity: 0; transition: opacity 0.3s ease;
            background-color: var(--bg-color);
            -webkit-overflow-scrolling: touch;
        }
        .page.active { display: block; opacity: 1; z-index: 10; }
      
        /* Map Page Specific */
        #page-map { padding: 0 0 80px 0; }
        #map-container { width: 100%; height: 100%; }
        /* 子頁面 */
        .sub-page {
            position: absolute; top: 0; left: 0; width: 100%; height: 100%;
            background-color: var(--bg-color); z-index: 2000;
            display: flex; flex-direction: column;
            transform: translateX(100%); transition: transform 0.3s cubic-bezier(0.4, 0.0, 0.2, 1);
        }
        .sub-page.open { transform: translateX(0); }
        .sub-header {
            padding: 15px 20px; background: var(--menu-bg);
            border-bottom: 1px solid var(--accent-color);
            display: flex; align-items: center; gap: 15px;
        }
        .back-btn { font-size: 1.2rem; color: var(--accent-color); background: none; border: none; padding: 5px; cursor: pointer;}
        .sub-header h2 { margin: 0; font-size: 1.1rem; color: var(--text-on-light); }
        .sub-content {
            flex: 1; overflow-y: auto; padding: 20px;
            -webkit-overflow-scrolling: touch;
        }
        /* --- Timeline & Cards --- */
        .timeline-container { padding: 0 20px; }
        .timeline-item {
            position: relative; padding-left: 25px; padding-bottom: 30px;
            border-left: 2px solid var(--accent-color);
        }
        .timeline-item:last-child { border-left: 2px solid transparent; padding-bottom: 0; }
        .timeline-item::before {
            content: ''; position: absolute; left: -6px; top: 18px;
            width: 10px; height: 10px; background: var(--accent-color);
            border-radius: 50%; box-shadow: 0 0 0 4px var(--bg-color);
        }
        .card {
            background-color: var(--card-color); color: var(--text-on-light);
            border-radius: 8px;
            padding: 16px; margin-bottom: 5px;
            box-shadow: 0 2px 4px rgba(0,0,0,0.1);
            cursor: pointer;
            position: relative;
        }
        .card:active { transform: scale(0.98); }
        .card-time { font-size: 0.85rem; color: var(--accent-color); font-weight: 700; display: block; margin-bottom: 6px; }
        .card-title { font-size: 1.1rem; font-weight: 700; margin: 0 0 8px 0; line-height: 1.4; padding-right: 10px; }
        .card-price {
            position: absolute; bottom: 12px; right: 15px;
            font-weight: bold; color: var(--accent-color); font-size: 0.9rem;
            background: var(--menu-bg); padding: 2px 6px; border-radius: 4px;
        }
        .tags { display: flex; gap: 6px; flex-wrap: wrap; margin-top: 5px; max-width: 70%; }
        .card-tag { font-size: 0.7rem; background: var(--menu-bg); padding: 3px 8px; border-radius: 4px; color: var(--text-on-light); }
        .card-tag.highlight { background: var(--accent-color); color: var(--text-on-dark); border: 1px solid var(--accent-color); }
        .card-tag.tips { background: var(--menu-bg); color: var(--text-on-light); }
        .card-tag.alert { background: var(--accent-color); color: var(--text-on-dark); border: 1px solid var(--accent-color); font-weight: bold;}
        /* --- Weather Styles --- */
        .weather-card {
            background: var(--weather-gradient);
            border-radius: 8px; padding: 25px; margin: 20px;
            text-align: center; color: var(--text-on-dark);
            box-shadow: 0 2px 4px rgba(0,0,0,0.1);
        }
        .weather-main { display: flex; justify-content: space-around; align-items: center; margin: 20px 0; }
        .weather-icon { font-size: 3.5rem; }
        .weather-temp { font-size: 3rem; font-weight: 300; }
        .weather-grid { display: grid; grid-template-columns: 1fr 1fr; gap: 15px; margin-top: 20px; background: rgba(255,255,255,0.1); padding: 15px; border-radius: 8px; }
        .w-item { font-size: 0.9rem; display: flex; align-items: center; gap: 8px; }
        /* --- Shopping Styles --- */
        .shopping-section-title { margin: 0 0 10px 0; color: var(--accent-color); border-bottom: 1px solid var(--menu-bg); padding-bottom: 5px;}
        .shopping-group { margin-bottom: 25px; background: var(--menu-bg); padding: 15px; border-radius: 8px; }
        /* --- Tools Grid --- */
        .tools-grid { display: grid; grid-template-columns: 1fr 1fr; gap: 15px; padding: 10px; }
        .tool-btn {
            background: var(--menu-bg); padding: 25px 15px;
            border-radius: 8px; text-align: center;
            border: 1px solid var(--accent-color); cursor: pointer;
        }
        .tool-btn i { font-size: 2.2rem; color: var(--accent-color); margin-bottom: 12px; display: block; }
        /* --- Lists --- */
        .checklist-item {
            background: var(--menu-bg); padding: 15px; margin-bottom: 12px;
            border-radius: 8px; display: flex; align-items: center; gap: 15px;
        }
        .checklist-item.checked { opacity: 0.5; }
        .checklist-item.checked span { text-decoration: line-through; }
        .checklist-item input { width: 22px; height: 22px; accent-color: var(--accent-color); }
      
        /* --- Footer --- */
        nav.bottom-nav {
            position: fixed; bottom: 0; width: 100%;
            background-color: var(--menu-bg);
            display: flex; justify-content: space-around;
            padding: 10px 0 25px 0; border-top: 1px solid var(--accent-color);
            z-index: 100;
        }
        .nav-item { color: var(--text-on-light); text-align: center; font-size: 0.75rem; cursor: pointer; width: 25%; }
        .nav-item i { display: block; font-size: 1.4rem; margin-bottom: 4px; }
        .nav-item.active { color: var(--accent-color); }
        /* --- Modal --- */
        .modal {
            display: none; position: fixed; top: 0; left: 0; width: 100%; height: 100%;
            background: rgba(0,0,0,0.7); z-index: 3000;
            justify-content: center; align-items: end; backdrop-filter: blur(3px);
        }
        .modal.open { display: flex; }
        .modal-content {
            background: var(--card-color); color: var(--text-on-light);
            width: 100%; max-width: 600px; max-height: 85vh;
            border-radius: 8px 8px 0 0; padding: 25px;
            overflow-y: auto; animation: slideUp 0.3s ease;
            -webkit-overflow-scrolling: touch;
        }
        @keyframes slideUp { from { transform: translateY(100%); } to { transform: translateY(0); } }
        .close-modal { position: absolute; top: 15px; right: 20px; font-size: 1.8rem; color: var(--accent-color); cursor: pointer; }
      
        .info-row { margin: 12px 0; display: flex; align-items: flex-start; gap: 12px; font-size: 0.95rem; line-height: 1.6; }
        .info-row i { color: var(--accent-color); margin-top: 4px; width: 20px; text-align: center; }
        .note-box {
            background: var(--menu-bg);
            border-left: 4px solid var(--accent-color);
            padding: 15px; margin: 20px 0; border-radius: 0 8px 8px 0;
            font-size: 0.95rem; color: var(--text-on-light); line-height: 1.7;
        }
        .link-btn {
            display: inline-block; background: var(--menu-bg); color: var(--text-on-light);
            padding: 6px 12px; border-radius: 4px; text-decoration: none;
            font-size: 0.85rem; margin-top: 5px; border: 1px solid var(--accent-color);
        }
        .action-btn {
            display: flex; justify-content: center; align-items: center; gap: 8px;
            width: 100%; padding: 14px; margin-top: 20px;
            background: var(--accent-color); color: var(--text-on-dark);
            text-decoration: none; border-radius: 8px;
            font-weight: bold; font-size: 1rem; border: none; cursor: pointer;
        }
      
        /* Taxi Card */
        .taxi-card {
            background: var(--card-color); color: var(--text-on-light); padding: 20px;
            border: 1px solid var(--accent-color);
            margin: 15px 0;
            text-align: center; border-radius: 8px;
        }
        /* Edit Form Styles */
        .edit-form { display: none; padding: 20px; background: rgba(0,0,0,0.5); position: fixed; top: 0; left: 0; width: 100%; height: 100%; z-index: 2500; justify-content: center; align-items: center; }
        .edit-form.open { display: flex; }
        .edit-content { background: var(--card-color); color: var(--text-on-light); padding: 20px; border-radius: 8px; width: 90%; max-width: 400px; }
        .edit-content input, .edit-content textarea { width: 100%; margin: 10px 0; padding: 8px; background: var(--menu-bg); border: 1px solid var(--accent-color); color: var(--text-on-light); }
        .edit-content button { background: var(--accent-color); color: var(--text-on-dark); border: none; padding: 10px; width: 100%; cursor: pointer; }
    </style>
</head>
<body>
    <header>
        <h1>Travel App Template</h1>
        <div class="header-icons">
            <a href="googletranslate://" class="header-btn" title="Google Translate">
                <i class="fa-solid fa-language"></i>
            </a>
            <a href="#" class="header-btn fan-btn" onclick="openToolsPage(); return false;">
                <i class="fa-solid fa-fan fa-spin" style="animation-duration: 10s;"></i>
            </a>
            <a href="#" class="header-btn" onclick="openEditForm(); return false;" title="Add Event">
                <i class="fa-solid fa-plus"></i>
            </a>
        </div>
    </header>
    <div class="date-selector-container">
        <div class="date-selector" id="date-selector"></div>
    </div>
    <main>
        <div id="page-itinerary" class="page active">
            <div class="timeline-container" id="timeline-container" style="padding-top: 20px;"></div>
            <div style="text-align:center; color:var(--accent-color); font-size:0.8rem; margin:30px 0;">平安喜樂 • 滿載而歸</div>
        </div>
        <div id="page-map" class="page">
            <div id="map-container"></div>
            <div style="position:absolute; bottom:90px; left:10px; background:var(--card-color); padding:8px 12px; border-radius:8px; color:var(--text-on-light); font-size:0.8rem; box-shadow:0 2px 5px rgba(0,0,0,0.1); pointer-events:none; z-index:999;">
                <i class="fa-solid fa-location-dot" style="color:var(--accent-color)"></i> 顯示當日行程地點
            </div>
        </div>
        <div id="page-weather" class="page">
            <div style="padding: 20px;">
                <h2 style="text-align:center; margin-bottom:10px;">當日天氣預報</h2>
                <div id="weather-content"></div>
              
                <div style="background:var(--menu-bg); padding:15px; border-radius:8px; margin:20px 0; display:flex; align-items:center; justify-content:space-between; border:1px solid var(--accent-color);">
                    <div>
                        <div style="font-weight:bold; color:var(--accent-color);"><i class="fa-solid fa-glass-water"></i> 水分補給 Check</div>
                        <div style="font-size:0.8rem; opacity:0.7; margin-top:4px;">喝酒前請先喝水</div>
                    </div>
                    <div style="display:flex; gap:15px; align-items:center;">
                        <button onclick="addWater()" style="background:var(--accent-color); border:none; color:var(--text-on-dark); width:45px; height:45px; border-radius:50%; font-size:1.2rem; cursor:pointer;"><i class="fa-solid fa-plus"></i></button>
                        <span id="water-count" style="font-size:2rem; min-width:30px; text-align:center;">0</span>
                    </div>
                </div>
                <div class="note-box">
                    <div style="font-weight:bold; margin-bottom:5px; color:var(--accent-color);">氣候 TIPS：</div>
                    [在此放入氣候提示範例]
                </div>
            </div>
        </div>
        <div id="page-shopping" class="page">
            <div style="padding: 20px;">
                <h2 style="text-align:center;">今日購物建議</h2>
                <p style="text-align:center; opacity:0.7; font-size:0.85rem; margin-bottom:20px;">根據當日行程地點推薦</p>
              
                <div id="daily-shopping-list"></div>
                <div style="margin-top:40px; border-top:1px solid var(--menu-bg); padding-top:20px;">
                    <h3 style="color:var(--accent-color); font-size:1rem;">全行程購物清單 (General)</h3>
                    <div id="general-shopping-container"></div>
                </div>
            </div>
        </div>
        <div id="page-tools" class="page">
            <h2 style="text-align:center; margin: 30px 0 20px 0;">旅人百寶箱</h2>
            <div class="tools-grid">
                <div class="tool-btn" onclick="openSubPage('hotel')">
                    <i class="fa-solid fa-bed"></i><span>酒店資訊</span>
                </div>
                <div class="tool-btn" onclick="openSubPage('packing')">
                    <i class="fa-solid fa-suitcase"></i><span>行李清單</span>
                </div>
                <div class="tool-btn" onclick="switchMainPage('shopping')">
                    <i class="fa-solid fa-basket-shopping"></i><span>查看購物</span>
                </div>
                <div class="tool-btn" onclick="openSubPage('rate')">
                    <i class="fa-solid fa-yen-sign"></i><span>匯率換算</span>
                </div>
                <div class="tool-btn" onclick="openSubPage('safety')">
                    <i class="fa-solid fa-user-shield"></i><span>安全報平安</span>
                </div>
                <div class="tool-btn" onclick="openTipsModal()">
                    <i class="fa-regular fa-compass"></i><span>路痴救星</span>
                </div>
            </div>
            <div style="text-align:center; margin-top:30px;">
                <button onclick="history.back()" style="background:none; border:1px solid var(--accent-color); color:var(--text-on-light); padding:10px 20px; border-radius:8px;">關閉百寶箱</button>
            </div>
        </div>
        <div id="subpage-hotel" class="sub-page">
            <div class="sub-header"><button class="back-btn" onclick="closeSubPage('hotel')"><i class="fa-solid fa-arrow-left"></i></button><h2>酒店資訊</h2></div>
            <div class="sub-content">
                <h3 style="color:var(--accent-color); margin-bottom:10px;">[酒店名稱範例]</h3>
                <div style="font-size:0.9rem; opacity:0.8; margin-bottom:20px;">[酒店簡介範例]</div>
              
                <div class="note-box">
                    <i class="fa-solid fa-location-dot" style="color:var(--accent-color)"></i> <b>地址：</b><br>
                    [地址範例]<br>
                    <span style="font-size:0.8rem; color:#666;">(英文地址)</span><br>
                    <a href="https://www.google.com/maps/search/?api=1&query=lat,long" target="_blank" class="link-btn" style="margin-top:8px;">開啟地圖</a>
                </div>
                <div class="checklist-item" style="opacity:1;">
                    <i class="fa-regular fa-clock" style="color:var(--accent-color)"></i>
                    <span><b>Check-in:</b> 時間 / <b>Out:</b> 時間</span>
                </div>
                <h4 style="border-bottom:1px solid var(--menu-bg); padding-bottom:5px; margin-top:25px;">特色</h4>
                <ul style="padding-left:20px; line-height:1.6; font-size:0.95rem;">
                    <li>[特色1範例]</li>
                    <li>[特色2範例]</li>
                </ul>
            </div>
        </div>
        <div id="subpage-packing" class="sub-page">
            <div class="sub-header"><button class="back-btn" onclick="closeSubPage('packing')"><i class="fa-solid fa-arrow-left"></i></button><h2>行李清單</h2></div>
            <div class="sub-content" id="packing-list-container"></div>
        </div>
      
        <div id="subpage-rate" class="sub-page">
            <div class="sub-header"><button class="back-btn" onclick="closeSubPage('rate')"><i class="fa-solid fa-arrow-left"></i></button><h2>匯率換算</h2></div>
            <div class="sub-content" style="display:flex; flex-direction:column; align-items:center; justify-content:center; height:80%;">
                <div style="background: var(--menu-bg); padding: 20px; border-radius: 8px; width:100%;">
                    <div style="display:flex; justify-content:flex-end; margin-bottom:10px;">
                         <label style="font-size:0.8rem; color:var(--text-on-light);">匯率: <input type="number" id="rate-setting" value="0.052" step="0.001" style="width:60px; background:transparent; color:var(--text-on-light); border:1px solid var(--accent-color); text-align:center; border-radius:4px;"></label>
                    </div>
                    <label>外幣</label><input type="number" id="jpy-input" placeholder="外幣" oninput="calcRate('jpy')" style="width: 100%; padding: 15px; margin: 10px 0; font-size: 1.2rem; background: var(--bg-color); border: 1px solid var(--accent-color); color: var(--text-on-light); border-radius: 8px; text-align: center;">
                    <div style="text-align:center; font-size:1.5rem; margin:10px 0; color:var(--accent-color);">⇅</div>
                    <label>港幣 (HKD)</label><input type="number" id="hkd-input" placeholder="$" oninput="calcRate('hkd')" style="width: 100%; padding: 15px; margin: 10px 0; font-size: 1.2rem; background: var(--bg-color); border: 1px solid var(--accent-color); color: var(--text-on-light); border-radius: 8px; text-align: center;">
                </div>
            </div>
        </div>
      
        <div id="subpage-safety" class="sub-page">
            <div class="sub-header"><button class="back-btn" onclick="closeSubPage('safety')"><i class="fa-solid fa-arrow-left"></i></button><h2>安全功能</h2></div>
            <div class="sub-content">
                <div style="text-align: center; padding: 30px 20px; background: var(--weather-gradient); border-radius: 8px; margin-bottom: 20px;" onclick="sendSafetyMessage()">
                    <i class="fa-brands fa-whatsapp" style="font-size:3rem; color:var(--text-on-dark); margin-bottom:15px;"></i>
                    <h3 style="margin:0 0 10px 0;">一鍵報平安 (WhatsApp)</h3>
                    <p style="opacity:0.8; margin:0;">按此發送位置給家人</p>
                </div>
                <h3 style="border-bottom:1px solid var(--menu-bg); padding-bottom:10px; margin-top:30px;">緊急資訊</h3>
                <div class="checklist-item" onclick="alert('緊急電話')"><i class="fa-solid fa-shield-halved" style="color:var(--accent-color);"></i><span>警察局: [號碼]</span></div>
                <div class="checklist-item" onclick="alert('緊急電話')"><i class="fa-solid fa-truck-medical" style="color:var(--accent-color);"></i><span>救護/消防: [號碼]</span></div>
            </div>
        </div>
    </main>
    <nav class="bottom-nav">
        <div class="nav-item active" onclick="switchMainPage('itinerary', this)"><i class="fa-solid fa-calendar-days"></i> 行程</div>
        <div class="nav-item" onclick="switchMainPage('map', this)"><i class="fa-solid fa-map-location-dot"></i> 地圖</div>
        <div class="nav-item" onclick="switchMainPage('weather', this)"><i class="fa-solid fa-cloud-sun-rain"></i> 天氣</div>
        <div class="nav-item" onclick="switchMainPage('shopping', this)"><i class="fa-solid fa-basket-shopping"></i> 購物</div>
    </nav>
    <div id="detail-modal" class="modal">
        <div class="modal-content">
            <span class="close-modal" onclick="closeModal()">×</span>
            <div class="modal-header"><h2 id="modal-title">標題</h2><span id="modal-type" class="sub">類型</span></div>
            <div class="modal-body">
              
                <div id="taxi-card" class="taxi-card" style="display:none;">
                    <p style="font-size:0.8rem; color:var(--accent-color); margin:0 0 5px 0;">[給司機看的訊息]</p>
                    <h2 id="taxi-address" style="font-size:1.5rem; margin:5px 0; font-weight:bold; line-height:1.2;"></h2>
                    <p id="taxi-name" style="font-size:1rem; margin-top:5px; color:var(--text-on-light);"></p>
                </div>
                <div class="info-row"><i class="fa-regular fa-clock"></i><span id="modal-time">時間</span></div>
                <div class="info-row"><i class="fa-solid fa-location-dot"></i><span id="modal-address">地址</span></div>
                <div class="info-row" id="modal-price-row"><i class="fa-solid fa-money-bill-wave"></i><span id="modal-price"></span></div>
              
                <div class="note-box">
                    <div style="font-weight:bold; margin-bottom:8px; color:var(--accent-color);">攻略與 TIPS：</div>
                    <span id="modal-note">內容...</span>
                </div>
                <div id="modal-links" style="margin-bottom: 20px;"></div>
              
                <div style="display:grid; grid-template-columns: 1fr 1fr; gap:10px; margin-top:20px;">
                     <button class="action-btn" id="modal-map-btn" style="margin-top:0;"><i class="fa-solid fa-map-location-dot"></i> Google 導航</button>
                     <button class="action-btn" onclick="toggleTaxiCard()" style="margin-top:0; background:var(--accent-color);"><i class="fa-solid fa-taxi"></i> 給司機看</button>
                </div>
            </div>
        </div>
    </div>
    <!-- Edit Form Modal -->
    <div id="edit-form" class="edit-form" onclick="if(event.target===this)closeEditForm()">
        <div class="edit-content">
            <h3>添加新行程事件</h3>
            <input type="text" id="edit-time" placeholder="時間 (e.g. 14:00 - 16:00)">
            <input type="text" id="edit-title" placeholder="標題">
            <input type="text" id="edit-type" placeholder="類型 (e.g. 美食)">
            <input type="text" id="edit-price" placeholder="價格 (e.g. ¥2,000)">
            <input type="text" id="edit-address" placeholder="地址">
            <input type="text" id="edit-coords" placeholder="座標 (e.g. 34.9858,135.7588) - 可選">
            <textarea id="edit-note" placeholder="筆記 (HTML支援)"></textarea>
            <input type="text" id="edit-tags" placeholder="標籤 (逗號分隔, e.g. 美食,必去)">
            <input type="text" id="edit-shopping" placeholder="購物項目 (逗號分隔)">
            <input type="text" id="edit-link" placeholder="連結 (可選)">
            <button onclick="saveNewEvent()">儲存</button>
        </div>
    </div>
    <script src="https://unpkg.com/leaflet@1.9.4/dist/leaflet.js"></script>
    <script>
        // --- DATA: Template 版本，只保留少量演示資料。用戶可編輯 scheduleData 替換為自己的行程 ---
        let scheduleData = {
            "day1": {
                "date": "[日期範例]",
                "events": [
                    { time: "[時間範例]", title: "[事件標題範例]", type: "[類型範例]", price: "[價格範例]", address: "[地址範例]", coords: [緯度, 經度], note: "[筆記範例]", tags: ["[標籤1]", "[標籤2]"], shopping_items: ["[購物項目1]", "[購物項目2]"] }
                ]
            }
            // 加入更多日子時，請複製以上格式，並在 events 陣列中添加事件資料
        };
        const packingList = ["[行李項目範例1]", "[行李項目範例2]"]; // 範例清單，可替換
        const generalShoppingListItems = ["[購物項目範例1]", "[購物項目範例2]"]; // 範例全行程購物，可替換
        let currentDay = "day1";
        let map = null;
        let markers = [];
        let waterCount = 0;
        // --- Logic ---
        function init() {
            loadCustomData(); // Load from localStorage
            renderDateSelector();
            selectDay('day1', document.querySelector('.date-chip')); // Default Init
            renderPackingList();
            renderGeneralShoppingList();
            initMap();
            fetchExchangeRate(); // Fetch real-time rate
        }
        function loadCustomData() {
            const saved = localStorage.getItem('scheduleData');
            if (saved) {
                const customData = JSON.parse(saved);
                Object.keys(customData).forEach(day => {
                    if (!scheduleData[day]) scheduleData[day] = customData[day];
                    else scheduleData[day].events = [...scheduleData[day].events, ... (customData[day].events || [])];
                });
            }
        }
        function saveCustomData() {
            localStorage.setItem('scheduleData', JSON.stringify(scheduleData));
        }
        function switchMainPage(pageId, navEl) {
            document.querySelectorAll('.page').forEach(p => p.classList.remove('active'));
            document.getElementById('page-' + pageId).classList.add('active');
          
            document.querySelectorAll('.nav-item').forEach(n => n.classList.remove('active'));
            if(navEl) {
                navEl.classList.add('active');
            } else {
                const idx = ['itinerary', 'map', 'weather', 'shopping'].indexOf(pageId);
                if(idx !== -1) document.querySelectorAll('.nav-item')[idx].classList.add('active');
            }
            if(pageId === 'map' && map) {
                setTimeout(() => { map.invalidateSize(); fitMapToDay(); }, 200);
            }
        }
        function openToolsPage() {
            document.querySelectorAll('.page').forEach(p => p.classList.remove('active'));
            document.getElementById('page-tools').classList.add('active');
            document.querySelectorAll('.nav-item').forEach(n => n.classList.remove('active'));
        }
        function openSubPage(id) { document.getElementById('subpage-' + id).classList.add('open'); }
        function closeSubPage(id) { document.getElementById('subpage-' + id).classList.remove('open'); }
        function renderDateSelector() {
            const container = document.getElementById('date-selector'); container.innerHTML = '';
            Object.keys(scheduleData).forEach(dayKey => {
                const dayInfo = scheduleData[dayKey];
                const dayNum = dayKey.replace('day', '');
                const chip = document.createElement('div');
                chip.className = `date-chip ${dayKey === 'day1' ? 'active' : ''}`;
                chip.onclick = () => selectDay(dayKey, chip);
                chip.innerHTML = `<span class="day-num">D${dayNum}</span><span class="day-week">${dayInfo.date.split(' ')[0]}</span>`;
                container.appendChild(chip);
            });
        }
        function selectDay(dayKey, chipEl) {
            currentDay = dayKey;
            document.querySelectorAll('.date-chip').forEach(c => c.classList.remove('active'));
            chipEl.classList.add('active');
          
            renderTimeline(dayKey);
            renderWeather(dayKey);
            renderDailyShopping(dayKey);
            if(map) updateMapMarkers(dayKey);
        }
        function renderTimeline(dayKey) {
            const container = document.getElementById('timeline-container'); container.innerHTML = '';
            const dayTitle = document.createElement('h3'); dayTitle.style.marginBottom='20px';
            dayTitle.innerHTML = `<span style="color:var(--accent-color);">${scheduleData[dayKey].date}</span>`;
            container.appendChild(dayTitle);
            scheduleData[dayKey].events.forEach(event => {
                const item = document.createElement('div'); item.className = 'timeline-item';
                let tagsHtml = event.tags ? event.tags.map(t => {
                    let c = 'card-tag';
                    if(t.includes('必')||t.includes('路痴')||t.includes('重點')) c+=' highlight';
                    if(t.includes('管制')) c+=' alert';
                    return `<span class="${c}">${t}</span>`;
                }).join('') : '';
              
                let priceHtml = event.price ? `<div class="card-price">${event.price}</div>` : '';
                item.innerHTML = `<div class="card" onclick='openEventModal(${JSON.stringify(event)})'>
                    <span class="card-time">${event.time}</span>
                    <h3 class="card-title">${event.title}</h3>
                    <div class="tags">${tagsHtml}</div>
                    ${priceHtml}
                </div>`;
                container.appendChild(item);
            });
        }
        async function renderWeather(dayKey) {
            const container = document.getElementById('weather-content');
            container.innerHTML = '<p>Loading weather...</p>';
            try {
                const response = await fetch('https://api.open-meteo.com/v1/forecast?latitude=[緯度]&longitude=[經度]&current=temperature_2m,relative_humidity_2m,weather_code,wind_speed_10m&daily=temperature_2m_max,temperature_2m_min,precipitation_probability_max&timezone=[時區]');
                const data = await response.json();
                const current = data.current;
                const daily = data.daily;
               
                let icon = "fa-cloud-sun";
                let desc = "多雲";
                if (current.weather_code === 0) { icon = "fa-sun"; desc = "晴朗"; }
                else if (current.weather_code >= 1 && current.weather_code <= 3) { icon = "fa-cloud"; desc = "多雲"; }
                else if (current.weather_code >= 51) { icon = "fa-cloud-rain"; desc = "有雨"; }
               
                const temp = Math.round(current.temperature_2m);
                const humidity = current.relative_humidity_2m;
                const rainChance = daily.precipitation_probability_max[0];
               
                container.innerHTML = `
                    <div class="weather-card">
                        <div style="font-size:0.9rem; opacity:0.9;">${scheduleData[dayKey].date} • [地點]</div>
                        <div class="weather-main">
                            <div class="weather-icon"><i class="fa-solid ${icon}"></i></div>
                            <div class="weather-temp">${temp}°C</div>
                        </div>
                        <div style="font-size:1.2rem; margin-bottom:15px;">${desc}</div>
                        <div class="weather-grid">
                            <div class="w-item"><i class="fa-solid fa-droplet"></i> 濕度 ${humidity}%</div>
                            <div class="w-item"><i class="fa-solid fa-umbrella"></i> 降雨 ${rainChance}%</div>
                            <div class="w-item"><i class="fa-solid fa-wind"></i> 風速 ${current.wind_speed_10m} km/h</div>
                            <div class="w-item"><i class="fa-solid fa-temperature-arrow-up"></i> 體感 ${temp + 2}°</div>
                        </div>
                    </div>
                `;
            } catch (error) {
                container.innerHTML = '<p>無法載入天氣數據，請檢查網路。</p>';
            }
        }
      
        function addWater() {
            waterCount++;
            document.getElementById('water-count').innerText = waterCount;
        }
        function renderDailyShopping(dayKey) {
            const container = document.getElementById('daily-shopping-list');
            container.innerHTML = '';
          
            const events = scheduleData[dayKey].events;
            let hasItems = false;
            events.forEach(event => {
                if (event.shopping_items && event.shopping_items.length > 0) {
                    hasItems = true;
                    const group = document.createElement('div');
                    group.className = 'shopping-group';
                  
                    let itemsHtml = '';
                    event.shopping_items.forEach((item, i) => {
                        const id = `shop-${dayKey}-${event.title}-${i}`;
                        itemsHtml += `<div class="checklist-item" onclick="toggleCheck(this)">
                            <input type="checkbox" id="${id}">
                            <label for="${id}"><span>${item}</span></label>
                        </div>`;
                    });
                    group.innerHTML = `<h4 class="shopping-section-title"><i class="fa-solid fa-location-dot"></i> ${event.title}</h4>${itemsHtml}`;
                    container.appendChild(group);
                }
            });
            if (!hasItems) {
                container.innerHTML = `<div style="text-align:center; padding:30px; opacity:0.5;">
                    <i class="fa-solid fa-bag-shopping" style="font-size:2rem; margin-bottom:10px;"></i><br>
                    本日以觀光為主，無特定購物建議
                </div>`;
            }
        }
        function renderGeneralShoppingList() {
            const container = document.getElementById('general-shopping-container');
            generalShoppingListItems.forEach((item,i) => {
                container.innerHTML += `<div class="checklist-item" onclick="toggleCheck(this)"><input type="checkbox" id="g${i}"><label for="g${i}"><span>${item}</span></label></div>`;
            });
        }
        function renderPackingList() {
            const pC = document.getElementById('packing-list-container');
            pC.innerHTML = '';
            packingList.forEach((item,i) => pC.innerHTML += `<div class="checklist-item" onclick="toggleCheck(this)"><input type="checkbox" id="p${i}"><label for="p${i}"><span>${item}</span></label></div>`);
        }
        function toggleCheck(el) { const i = el.querySelector('input'); i.checked = !i.checked; el.classList.toggle('checked', i.checked); }
        async function fetchExchangeRate() {
            try {
                const response = await fetch('https://api.frankfurter.app/latest?amount=1&from=[外幣]&to=HKD');
                const data = await response.json();
                const rate = data.rates.HKD;
                document.getElementById('rate-setting').value = rate.toFixed(3);
            } catch (error) {
                console.error('Failed to fetch exchange rate:', error);
            }
        }
        function calcRate(type) {
            const rate = parseFloat(document.getElementById('rate-setting').value) || 0.052;
            const jpy = document.getElementById('jpy-input');
            const hkd = document.getElementById('hkd-input');
          
            if(type==='jpy') {
                if(jpy.value === '') hkd.value = '';
                else hkd.value = (jpy.value * rate).toFixed(1);
            } else {
                if(hkd.value === '') jpy.value = '';
                else jpy.value = (hkd.value / rate).toFixed(0);
            }
        }
        function sendSafetyMessage() {
             if (navigator.geolocation) {
                navigator.geolocation.getCurrentPosition(function(pos) {
                    const link = `https://www.google.com/maps/search/?api=1&query=${pos.coords.latitude},${pos.coords.longitude}`;
                    window.open(`https://wa.me/?text=${encodeURIComponent("Hello! 我在[地點]一切安好，目前位置：" + link)}`, '_blank');
                });
            } else alert("無法獲取定位");
        }
        function openEventModal(event) {
            document.getElementById('modal-title').innerText = event.title;
            document.getElementById('modal-type').innerText = event.type;
            document.getElementById('modal-time').innerText = event.time;
            document.getElementById('modal-address').innerText = event.address;
            document.getElementById('modal-note').innerHTML = event.note;
          
            document.getElementById('taxi-address').innerText = event.address;
            document.getElementById('taxi-name').innerText = event.title;
            document.getElementById('taxi-card').style.display = 'none';
            const priceRow = document.getElementById('modal-price-row');
            if (event.price) {
                priceRow.style.display = 'flex';
                document.getElementById('modal-price').innerText = "預算/門票：" + event.price;
            } else {
                priceRow.style.display = 'none';
            }
            const lc = document.getElementById('modal-links'); lc.innerHTML = '';
            if(event.link) lc.innerHTML = `<a href="${event.link}" target="_blank" class="link-btn"><i class="fa-solid fa-link"></i> 預約/詳情</a>`;
          
            let mapUrl = "";
            if(event.coords) {
                mapUrl = `https://www.google.com/maps/search/?api=1&query=${event.coords[0]},${event.coords[1]}`;
            } else {
                const q = encodeURIComponent(event.address + " " + event.title);
                mapUrl = `https://www.google.com/maps/search/?api=1&query=${q}`;
            }
            document.getElementById('modal-map-btn').onclick = () => window.open(mapUrl, '_blank');
            document.getElementById('detail-modal').classList.add('open');
        }
      
        function toggleTaxiCard() {
            const card = document.getElementById('taxi-card');
            card.style.display = card.style.display === 'none' ? 'block' : 'none';
        }
        function closeModal() { document.getElementById('detail-modal').classList.remove('open'); }
        document.getElementById('detail-modal').addEventListener('click', function(e){if(e.target===this)closeModal()});
        function openTipsModal() { openEventModal({title:"[提示標題範例]",type:"TIPS",time:"隨時",address:"[地點範例]",note:"[提示內容範例]", tags:[]}); }
        // --- Map Logic ---
        function initMap() {
            map = L.map('map-container');
            L.tileLayer('https://{s}.basemaps.cartocdn.com/light_all/{z}/{x}/{y}{r}.png', { attribution: '© OpenStreetMap' }).addTo(map);
            updateMapMarkers(currentDay);
        }
        function updateMapMarkers(dayKey) {
            if(!map) return;
            markers.forEach(m => map.removeLayer(m));
            markers = [];
          
            const events = scheduleData[dayKey].events;
            const group = new L.featureGroup();
            events.forEach(event => {
                if(event.coords && event.coords.length === 2) {
                    const navUrl = `https://www.google.com/maps/search/?api=1&query=${event.coords[0]},${event.coords[1]}`;
                    const popupContent = `
                        <div style="text-align:center">
                            <b>${event.title}</b><br>${event.time}<br>
                            <a href="${navUrl}" target="_blank" style="display:inline-block; margin-top:5px; color:var(--accent-color); text-decoration:none; font-weight:bold;">
                                <i class="fa-solid fa-location-arrow"></i> 導航
                            </a>
                        </div>
                    `;
                    const m = L.marker(event.coords).addTo(map).bindPopup(popupContent);
                    markers.push(m);
                    group.addLayer(m);
                }
            });
            if(markers.length > 0) {
                map.fitBounds(group.getBounds(), {padding: [50, 50]});
            } else {
                map.setView([0, 0], 13); // 預設視圖
            }
        }
      
        function fitMapToDay() {
            if(map && markers.length > 0) {
                const group = new L.featureGroup(markers);
                map.fitBounds(group.getBounds(), {padding: [50, 50]});
            }
        }
        // --- Edit Form Logic ---
        function openEditForm() {
            document.getElementById('edit-form').classList.add('open');
        }
        function closeEditForm() {
            document.getElementById('edit-form').classList.remove('open');
        }
        async function saveNewEvent() {
            const newEvent = {
                time: document.getElementById('edit-time').value,
                title: document.getElementById('edit-title').value,
                type: document.getElementById('edit-type').value,
                price: document.getElementById('edit-price').value,
                address: document.getElementById('edit-address').value,
                note: document.getElementById('edit-note').value,
                tags: document.getElementById('edit-tags').value.split(',').map(t => t.trim()),
                shopping_items: document.getElementById('edit-shopping').value.split(',').map(i => i.trim()),
                link: document.getElementById('edit-link').value
            };
            const coordsStr = document.getElementById('edit-coords').value;
            if (coordsStr) {
                newEvent.coords = coordsStr.split(',').map(c => parseFloat(c.trim()));
            } else if (newEvent.address) {
                // Try to geocode address using Nominatim (OpenStreetMap)
                try {
                    const response = await fetch(`https://nominatim.openstreetmap.org/search?format=json&q=${encodeURIComponent(newEvent.address)}`);
                    const data = await response.json();
                    if (data.length > 0) {
                        newEvent.coords = [parseFloat(data[0].lat), parseFloat(data[0].lon)];
                    }
                } catch (error) {
                    console.error('Geocoding failed:', error);
                }
            }
            if (!scheduleData[currentDay]) {
                scheduleData[currentDay] = { date: "[日期範例]", events: [] };
            }
            scheduleData[currentDay].events.push(newEvent);
            saveCustomData();
            renderDateSelector(); // 更新日期選擇器，如果新增日子
            renderTimeline(currentDay);
            renderDailyShopping(currentDay);
            updateMapMarkers(currentDay);
            closeEditForm();
            // Clear form
            document.querySelectorAll('.edit-content input, .edit-content textarea').forEach(el => el.value = '');
        }
        init();
    </script>
</body>
</html>
